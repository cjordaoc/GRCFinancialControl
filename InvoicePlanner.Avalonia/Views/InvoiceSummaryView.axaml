
<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="clr-namespace:InvoicePlanner.Avalonia.ViewModels"
             xmlns:loc="clr-namespace:App.Presentation.Localization;assembly=App.Presentation"
             x:Class="InvoicePlanner.Avalonia.Views.InvoiceSummaryView"
             x:DataType="vm:InvoiceSummaryViewModel"
             mc:Ignorable="d">
    <Grid RowDefinitions="Auto,Auto,Auto,*" RowSpacing="{StaticResource Spacing12}">
        <Border Grid.Row="0" Classes="Card" Padding="{StaticResource SpaceThickness16}" Margin="{StaticResource MarginInset}">
            <StackPanel Spacing="{StaticResource Spacing12}">
                <TextBlock Classes="TitleMedium" Text="{loc:Loc Key=InvoiceSummary.Title.Filters}" />
                <Grid ColumnDefinitions="*,*" ColumnSpacing="{StaticResource Spacing12}">
                    <StackPanel Spacing="{StaticResource Spacing4}">
                        <TextBlock Text="{loc:Loc Key=InvoiceSummary.Label.Engagement}" />
                        <ComboBox ItemsSource="{Binding Engagements}"
                                  SelectedItem="{Binding SelectedEngagement, Mode=TwoWay}">
                            <ComboBox.ItemTemplate>
                                <DataTemplate>
                                    <TextBlock Text="{Binding DisplayName}" />
                                </DataTemplate>
                            </ComboBox.ItemTemplate>
                        </ComboBox>
                    </StackPanel>
                    <StackPanel Grid.Column="1" Spacing="{StaticResource Spacing4}">
                        <TextBlock Text="{loc:Loc Key=InvoiceSummary.Label.Customer}" />
                        <ComboBox ItemsSource="{Binding Customers}"
                                  SelectedItem="{Binding SelectedCustomer, Mode=TwoWay}">
                            <ComboBox.ItemTemplate>
                                <DataTemplate>
                                    <TextBlock Text="{Binding DisplayName}" />
                                </DataTemplate>
                            </ComboBox.ItemTemplate>
                        </ComboBox>
                    </StackPanel>
                </Grid>
                <StackPanel Spacing="{StaticResource Spacing4}">
                    <TextBlock Text="{loc:Loc Key=InvoiceSummary.Label.Statuses}" />
                    <ItemsControl ItemsSource="{Binding StatusFilters}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <WrapPanel />
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <CheckBox Content="{Binding DisplayName}"
                                          Margin="{StaticResource MarginRightCompactBottomSmall}"
                                          IsChecked="{Binding IsSelected, Mode=TwoWay}" />
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </StackPanel>
                <StackPanel Orientation="Horizontal" Spacing="{StaticResource Spacing8}">
                    <Button Content="{loc:Loc Key=InvoiceSummary.Button.ApplyFilters}" Command="{Binding RefreshCommand}" />
                    <Button Content="{loc:Loc Key=InvoiceSummary.Button.ClearFilters}" Command="{Binding ClearFiltersCommand}" />
                    <Button Content="{loc:Loc Key=Common.Button.ExportExcel}" Command="{Binding ExportExcelCommand}" />
                    <Button Content="{loc:Loc Key=Common.Button.ExportPdf}" Command="{Binding ExportPdfCommand}" />
                </StackPanel>
            </StackPanel>
        </Border>

        <Border Grid.Row="1" Classes="Card" Padding="{StaticResource SpaceThickness16}" Margin="{StaticResource MarginInset}">
            <Grid ColumnDefinitions="*,*" ColumnSpacing="{StaticResource Spacing12}">
                <StackPanel Spacing="{StaticResource Spacing4}">
                    <TextBlock Text="{loc:Loc Key=InvoiceSummary.Section.Totals.Amount}" />
                    <TextBlock Classes="TitleMedium" Text="{Binding TotalAmountDisplay}" />
                </StackPanel>
                <StackPanel Grid.Column="1" Spacing="{StaticResource Spacing4}">
                    <TextBlock Text="{loc:Loc Key=InvoiceSummary.Section.Totals.Percentage}" />
                    <TextBlock Classes="TitleMedium" Text="{Binding TotalPercentage, StringFormat={}{0:N4}%}" />
                </StackPanel>
            </Grid>
        </Border>

        <StackPanel Grid.Row="2" Margin="{StaticResource MarginHorizontalMedium}" Spacing="{StaticResource Spacing4}">
            <TextBlock Classes="StatusSuccess" Text="{Binding StatusMessage}" IsVisible="{Binding HasStatusMessage}" />
            <TextBlock Classes="StatusError" Text="{Binding ValidationMessage}" IsVisible="{Binding HasValidationMessage}" />
        </StackPanel>

        <ScrollViewer Grid.Row="3" Margin="{StaticResource SpaceThickness16}" VerticalScrollBarVisibility="Auto">
            <ItemsControl ItemsSource="{Binding Groups}">
                <ItemsControl.ItemTemplate>
                    <DataTemplate x:DataType="vm:InvoiceSummaryGroupViewModel">
                        <Border Classes="Card" Padding="{StaticResource SpaceThickness16}" Margin="{StaticResource MarginBottomRegular}">
                            <StackPanel Spacing="{StaticResource Spacing12}">
                                <StackPanel Orientation="Horizontal" Spacing="{StaticResource Spacing16}" VerticalAlignment="Center">
                                    <TextBlock Classes="TitleMedium" Text="{Binding EngagementName}" />
                                    <TextBlock Text="{Binding CustomerName}" />
                                    <TextBlock Text="{Binding CustomerCode}" />
                                </StackPanel>
                                <StackPanel Orientation="Horizontal" Spacing="{StaticResource Spacing12}">
                                    <TextBlock Text="{Binding TotalAmountDisplay}" />
                                    <TextBlock Text="{Binding TotalPercentageDisplay}" />
                                    <TextBlock Text="{Binding PlannedCountDisplay}" />
                                    <TextBlock Text="{Binding RequestedCountDisplay}" />
                                    <TextBlock Text="{Binding ClosedCountDisplay}" />
                                    <TextBlock Text="{Binding CanceledCountDisplay}" />
                                    <TextBlock Text="{Binding EmittedCountDisplay}" />
                                </StackPanel>
                                <DataGrid ItemsSource="{Binding Items}"
                                          AutoGenerateColumns="False"
                                          HeadersVisibility="All"
                                          GridLinesVisibility="Horizontal"
                                          IsReadOnly="True"
                                          x:CompileBindings="False">
                                    <DataGrid.Columns>
                                        <DataGridTextColumn Header="{loc:Loc Key=InvoiceSummary.TableHeader.Sequence}" Binding="{Binding Sequence}" Width="40" />
                                        <DataGridTextColumn Header="{loc:Loc Key=InvoiceSummary.TableHeader.Plan}" Binding="{Binding PlanId}" Width="80" />
                                        <DataGridTextColumn Header="{loc:Loc Key=InvoiceSummary.TableHeader.Status}" Binding="{Binding StatusDisplay}" Width="100" />
                                        <DataGridTextColumn Header="{loc:Loc Key=InvoiceSummary.TableHeader.Type}" Binding="{Binding PlanType}" Width="100" />
                                        <DataGridTextColumn Header="{loc:Loc Key=InvoiceSummary.TableHeader.Percent}" Binding="{Binding Percentage, StringFormat={}{0:N4}}" Width="90" />
                                        <DataGridTemplateColumn Header="{loc:Loc Key=InvoiceSummary.TableHeader.Amount}" Width="120">
                                        <DataGridTemplateColumn.CellTemplate>
                                            <DataTemplate x:DataType="vm:InvoiceSummaryItemViewModel">
                                                <TextBlock Text="{Binding AmountDisplay}" />
                                            </DataTemplate>
                                        </DataGridTemplateColumn.CellTemplate>
                                    </DataGridTemplateColumn>
                                        <DataGridTemplateColumn Header="{loc:Loc Key=InvoiceSummary.TableHeader.BaseValue}" Width="120">
                                        <DataGridTemplateColumn.CellTemplate>
                                            <DataTemplate x:DataType="vm:InvoiceSummaryItemViewModel">
                                                <TextBlock Text="{Binding BaseValueDisplay}" />
                                            </DataTemplate>
                                        </DataGridTemplateColumn.CellTemplate>
                                    </DataGridTemplateColumn>
                                        <DataGridTextColumn Header="{loc:Loc Key=InvoiceSummary.TableHeader.EmissionDate}" Binding="{Binding EmissionDate, StringFormat={}{0:yyyy-MM-dd}}" Width="120" />
                                        <DataGridTextColumn Header="{loc:Loc Key=InvoiceSummary.TableHeader.DueDate}" Binding="{Binding DueDate, StringFormat={}{0:yyyy-MM-dd}}" Width="120" />
                                        <DataGridTextColumn Header="{loc:Loc Key=InvoiceSummary.TableHeader.RequestDate}" Binding="{Binding RequestDate, StringFormat={}{0:yyyy-MM-dd}}" Width="120" />
                                        <DataGridTextColumn Header="{loc:Loc Key=InvoiceSummary.TableHeader.EmittedAt}" Binding="{Binding EmittedAt, StringFormat={}{0:yyyy-MM-dd}}" Width="120" />
                                        <DataGridTextColumn Header="{loc:Loc Key=InvoiceSummary.TableHeader.BzCode}" Binding="{Binding BzCode}" Width="100" />
                                        <DataGridTextColumn Header="{loc:Loc Key=InvoiceSummary.TableHeader.Ritm}" Binding="{Binding RitmNumber}" Width="140" />
                                        <DataGridTextColumn Header="{loc:Loc Key=InvoiceSummary.TableHeader.CanceledAt}" Binding="{Binding CanceledAt, StringFormat={}{0:yyyy-MM-dd}}" Width="120" />
                                        <DataGridTextColumn Header="{loc:Loc Key=InvoiceSummary.TableHeader.CancelReason}" Binding="{Binding CancelReason}" Width="200" />
                                    </DataGrid.Columns>
                                </DataGrid>
                            </StackPanel>
                        </Border>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </ScrollViewer>
    </Grid>
</UserControl>
