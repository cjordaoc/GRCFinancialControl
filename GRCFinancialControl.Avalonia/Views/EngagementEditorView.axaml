<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:GRCFinancialControl.Avalonia.ViewModels"
             xmlns:loc="clr-namespace:App.Presentation.Localization;assembly=App.Presentation"
             mc:Ignorable="d" d:DesignWidth="500" d:DesignHeight="550"
             x:Class="GRCFinancialControl.Avalonia.Views.EngagementEditorView"
             x:Name="EngagementEditorRoot"
             x:DataType="vm:EngagementEditorViewModel">
    <Grid RowDefinitions="*,Auto" RowSpacing="16" Margin="0,0,0,0">
        <Panel>
        <Border Background="{DynamicResource SystemControlBackgroundChromeMediumLowBrush}"
                CornerRadius="8"/>

        <ScrollViewer>
            <StackPanel Spacing="10" Margin="20">
                <TextBlock Text="Engagement Details" FontSize="18" FontWeight="Bold"/>

                <Grid ColumnDefinitions="Auto,*,40,Auto,*"
                      RowDefinitions="Auto,Auto,Auto,Auto,Auto,Auto,Auto,Auto,Auto,Auto"
                      Margin="0,10,0,0">
                    <TextBlock Grid.Row="0" Grid.Column="0" Text="Engagement ID:" VerticalAlignment="Center"/>
                    <TextBox Grid.Row="0" Grid.Column="1" Text="{Binding EngagementId}" Margin="10,0,0,0" IsReadOnly="{Binding IsEngagementIdReadOnly}"/>

                    <TextBlock Grid.Row="0" Grid.Column="3" Text="Customer:" VerticalAlignment="Center"/>
                    <ComboBox Grid.Row="0" Grid.Column="4"
                              ItemsSource="{Binding Customers}"
                              SelectedItem="{Binding SelectedCustomer}"
                              DisplayMemberBinding="{Binding DisplayName}"
                              Margin="10,0,0,0"
                              IsEnabled="{Binding AllowEditing}"/>

                    <TextBlock Grid.Row="1" Grid.Column="0" Text="Description:" VerticalAlignment="Center"/>
                    <TextBox Grid.Row="1" Grid.Column="1" Grid.ColumnSpan="4" Text="{Binding Description}" Margin="10,4,0,0" IsReadOnly="{Binding IsGeneralFieldReadOnly}"/>

                    <TextBlock Grid.Row="2" Grid.Column="0" Text="Status:" VerticalAlignment="Center"/>
                    <ComboBox Grid.Row="2" Grid.Column="1"
                              ItemsSource="{Binding StatusTextOptions}"
                              SelectedItem="{Binding SelectedStatusText}"
                              Margin="10,4,0,0"
                              IsEnabled="{Binding AllowEditing}"/>

                    <TextBlock Grid.Row="2" Grid.Column="3" Text="Currency:" VerticalAlignment="Center"/>
                    <TextBox Grid.Row="2" Grid.Column="4" Text="{Binding Currency}" Margin="10,4,0,0" IsReadOnly="{Binding IsGeneralFieldReadOnly}"/>

                    <TextBlock Grid.Row="3" Grid.Column="0" Text="Source:" VerticalAlignment="Center"/>
                    <ComboBox Grid.Row="3" Grid.Column="1"
                              Grid.ColumnSpan="4"
                              ItemsSource="{Binding SourceOptions}"
                              SelectedItem="{Binding SelectedSource}"
                              DisplayMemberBinding="{Binding DisplayName}"
                              Margin="10,4,0,0"
                              IsEnabled="{Binding AllowEditing}"/>

                    <TextBlock Grid.Row="4" Grid.Column="0" Text="Opening Value:" VerticalAlignment="Center"/>
                    <TextBox Grid.Row="4" Grid.Column="1" Text="{Binding OpeningValue}" Margin="10,4,0,0" IsReadOnly="{Binding IsFinancialSnapshotReadOnly}"/>

                    <TextBlock Grid.Row="4" Grid.Column="3" Text="Value ETC-P:" VerticalAlignment="Center"/>
                    <TextBox Grid.Row="4" Grid.Column="4" Text="{Binding ValueEtcp}" Margin="10,4,0,0" IsReadOnly="{Binding IsGeneralFieldReadOnly}"/>

                    <TextBlock Grid.Row="5" Grid.Column="0" Text="Opening Expenses:" VerticalAlignment="Center"/>
                    <TextBox Grid.Row="5" Grid.Column="1" Text="{Binding OpeningExpenses}" Margin="10,4,0,0" IsReadOnly="{Binding IsFinancialSnapshotReadOnly}"/>

                    <TextBlock Grid.Row="5" Grid.Column="3" Text="Expenses ETC-P:" VerticalAlignment="Center"/>
                    <TextBox Grid.Row="5" Grid.Column="4" Text="{Binding ExpensesEtcp}" Margin="10,4,0,0" IsReadOnly="{Binding IsGeneralFieldReadOnly}"/>

                    <TextBlock Grid.Row="6" Grid.Column="0" Text="Planned Hours:" VerticalAlignment="Center"/>
                    <TextBox Grid.Row="6" Grid.Column="1" Text="{Binding InitialHoursBudget}" Margin="10,4,0,0" IsReadOnly="{Binding IsFinancialSnapshotReadOnly}"/>

                    <TextBlock Grid.Row="6" Grid.Column="3" Text="Estimated Hours:" VerticalAlignment="Center"/>
                    <TextBox Grid.Row="6" Grid.Column="4" Text="{Binding EstimatedToCompleteHours}" Margin="10,4,0,0" IsReadOnly="{Binding IsGeneralFieldReadOnly}"/>

                    <TextBlock Grid.Row="7" Grid.Column="0" Text="Margin % Budget:" VerticalAlignment="Center"/>
                    <TextBox Grid.Row="7" Grid.Column="1" Text="{Binding MarginPctBudget}" Margin="10,4,0,0" IsReadOnly="{Binding IsFinancialSnapshotReadOnly}"/>

                    <TextBlock Grid.Row="7" Grid.Column="3" Text="Margin % ETC-P:" VerticalAlignment="Center"/>
                    <TextBox Grid.Row="7" Grid.Column="4" Text="{Binding MarginPctEtcp}" Margin="10,4,0,0" IsReadOnly="{Binding IsGeneralFieldReadOnly}"/>

                    <TextBlock Grid.Row="8" Grid.Column="0" Text="ETC-P Age (Days):" VerticalAlignment="Center"/>
                    <TextBox Grid.Row="8" Grid.Column="1"
                             Text="{Binding EtcpAgeDays, Mode=OneWay}"
                             Margin="10,4,0,0"
                             IsReadOnly="True"
                             IsHitTestVisible="False"
                             IsTabStop="False"/>

                    <TextBlock Grid.Row="8" Grid.Column="3" Text="Last Closing Period:" VerticalAlignment="Center"/>
                    <TextBox Grid.Row="8" Grid.Column="4"
                             Text="{Binding LastClosingPeriodDisplay}"
                             Margin="10,4,0,0"
                             IsReadOnly="True"
                             IsHitTestVisible="False"
                             IsTabStop="False"/>

                    <TextBlock Grid.Row="9" Grid.Column="0" Text="Last ETC Date:" VerticalAlignment="Center"/>
                    <DatePicker Grid.Row="9" Grid.Column="1"
                                SelectedDate="{Binding LastEtcDateOffset}"
                                Margin="10,4,0,0"
                                IsEnabled="False"/>

                    <TextBlock Grid.Row="9" Grid.Column="3" Text="Proposed Next ETC Date:" VerticalAlignment="Center"/>
                    <DatePicker Grid.Row="9" Grid.Column="4"
                                SelectedDate="{Binding ProposedNextEtcDateOffset}"
                                Margin="10,4,0,0"
                                IsEnabled="False"/>
                </Grid>

                <TextBlock Text="PAPD Assignments" FontSize="16" FontWeight="Bold" Margin="0,20,0,5"/>
                <DataGrid ItemsSource="{Binding PapdAssignments}" AutoGenerateColumns="False" IsReadOnly="True" SelectionMode="Single" Height="150">
                <DataGrid.Columns>
                    <DataGridTextColumn Header="PAPD" Binding="{Binding Papd.Name}" Width="*"/>
                    <DataGridTextColumn Header="Effective Date" Binding="{Binding EffectiveDate, StringFormat='yyyy-MM-dd'}" Width="*"/>
                </DataGrid.Columns>
            </DataGrid>
                <TextBlock Text="Manager Assignments" FontSize="16" FontWeight="Bold" Margin="0,20,0,5"/>
                <DataGrid ItemsSource="{Binding ManagerAssignments}" AutoGenerateColumns="False" IsReadOnly="True" Height="150">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Manager" Binding="{Binding Manager.Name}" Width="*"/>
                        <DataGridTextColumn Header="Position" Binding="{Binding Manager.Position}" Width="*"/>
                        <DataGridTextColumn Header="Begin" Binding="{Binding BeginDate, StringFormat='{}{0:yyyy-MM-dd}'}" Width="*"/>
                        <DataGridTextColumn Header="End" Binding="{Binding EndDate, StringFormat='{}{0:yyyy-MM-dd}'}" Width="*"/>
                    </DataGrid.Columns>
                </DataGrid>

                <TextBlock Text="Financial Evolution Data" FontSize="16" FontWeight="Bold" Margin="0,20,0,5"/>
                <DataGrid ItemsSource="{Binding FinancialEvolutionEntries}"
                          SelectedItem="{Binding SelectedFinancialEvolutionEntry}"
                          AutoGenerateColumns="False"
                          Height="200"
                          IsReadOnly="{Binding IsReadOnlyMode}">
                    <DataGrid.Columns>
                        <DataGridTemplateColumn Header="Closing Period" Width="2*">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate x:DataType="vm:EngagementFinancialEvolutionEntryViewModel">
                                    <ComboBox ItemsSource="{Binding DataContext.ClosingPeriods, ElementName=EngagementEditorRoot}"
                                              SelectedItem="{Binding SelectedClosingPeriod}"
                                              DisplayMemberBinding="{Binding Name}"
                                              IsEnabled="{Binding CanEditClosingPeriod}"/>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>
                        <DataGridTextColumn Header="Closing Period ID" Binding="{Binding ClosingPeriodId, UpdateSourceTrigger=PropertyChanged}" Width="2*"/>
                        <DataGridTextColumn Header="Hours" Binding="{Binding Hours, UpdateSourceTrigger=PropertyChanged}" Width="*"/>
                        <DataGridTextColumn Header="Value" Binding="{Binding Value, UpdateSourceTrigger=PropertyChanged}" Width="*"/>
                        <DataGridTextColumn Header="Margin" Binding="{Binding Margin, UpdateSourceTrigger=PropertyChanged}" Width="*"/>
                        <DataGridTextColumn Header="Expenses" Binding="{Binding Expenses, UpdateSourceTrigger=PropertyChanged}" Width="*"/>
                    </DataGrid.Columns>
                </DataGrid>
                <StackPanel Orientation="Horizontal" Spacing="5" Margin="0,5,0,0" IsVisible="{Binding AllowEditing}">
                    <Button Content="Add Period Data" Command="{Binding AddFinancialEvolutionEntryCommand}" Classes="accent"/>
                    <Button Content="Remove Selected" Command="{Binding RemoveFinancialEvolutionEntryCommand}"/>
                </StackPanel>

            </StackPanel>
        </ScrollViewer>
        </Panel>
        <Border Grid.Row="1" Margin="20,0,20,20">
            <StackPanel Orientation="Horizontal"
                        HorizontalAlignment="Right"
                        Spacing="{StaticResource Space12}">
                <Button Content="{loc:Loc Key=Common.Button.Save}"
                        Command="{Binding SaveCommand}"
                        IsEnabled="{Binding AllowEditing}"
                        MinWidth="120" />
                <Button Content="{loc:Loc Key=Common.Button.Cancel}"
                        Command="{Binding CloseCommand}"
                        MinWidth="120" />
            </StackPanel>
        </Border>
    </Grid>
</UserControl>