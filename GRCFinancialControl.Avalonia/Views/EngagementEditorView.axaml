<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:GRCFinancialControl.Avalonia.ViewModels"
             xmlns:conv="clr-namespace:App.Presentation.Converters;assembly=App.Presentation"
             xmlns:loc="clr-namespace:App.Presentation.Localization;assembly=App.Presentation"
             xmlns:behaviors="clr-namespace:App.Presentation.Behaviors;assembly=App.Presentation"
             mc:Ignorable="d" d:DesignWidth="500" d:DesignHeight="550"
             x:Class="GRCFinancialControl.Avalonia.Views.EngagementEditorView"
             x:Name="EngagementEditorRoot"
             x:DataType="vm:EngagementEditorViewModel">
    <UserControl.Resources>
        <conv:PercentageOfSizeConverter x:Key="PercentageOfSizeConverter" />
    </UserControl.Resources>

    <Grid RowDefinitions="*,Auto" RowSpacing="{StaticResource GridGap}">
        <ScrollViewer Grid.Row="0"
                      VerticalScrollBarVisibility="Auto"
                      HorizontalScrollBarVisibility="Disabled"
                      HorizontalAlignment="Stretch"
                      HorizontalContentAlignment="Stretch"
                      Padding="{StaticResource CardPaddingThickness}">
            <StackPanel Spacing="{StaticResource SectionSpacing}"
                        HorizontalAlignment="Stretch"
                        MaxWidth="{Binding ElementName=EngagementEditorRoot,
                                            Path=Bounds.Width,
                                            Converter={StaticResource PercentageOfSizeConverter},
                                            ConverterParameter=0.85}">
                <TextBlock Text="Engagement Details" Classes="TitleSmall"/>

                <TabControl HorizontalAlignment="Stretch">
                    <TabItem Header="Engagement Data">
                        <StackPanel Spacing="{StaticResource SectionSpacing}">
                            <Grid ColumnDefinitions="*,*" ColumnSpacing="{StaticResource GridGap}">
                                <StackPanel Spacing="{StaticResource SpacingUnit}" Grid.Column="0">
                                    <TextBlock Text="Engagement ID:" VerticalAlignment="Center"/>
                                    <TextBox Text="{Binding EngagementId}"
                                             IsReadOnly="{Binding IsEngagementIdReadOnly}"
                                             HorizontalAlignment="Stretch"
                                             MinWidth="{StaticResource TextBoxMinWidth}"/>
                                </StackPanel>
                                <StackPanel Spacing="{StaticResource SpacingUnit}" Grid.Column="1">
                                    <TextBlock Text="Customer:" VerticalAlignment="Center"/>
                                    <ComboBox ItemsSource="{Binding Customers}"
                                              SelectedItem="{Binding SelectedCustomer}"
                                              DisplayMemberBinding="{Binding DisplayName}"
                                              IsEnabled="{Binding CanEditCustomer}"
                                              HorizontalAlignment="Stretch"
                                              MinWidth="{StaticResource ComboBoxMinWidth}"/>
                                </StackPanel>
                            </Grid>

                            <StackPanel Spacing="{StaticResource SpacingUnit}">
                                <TextBlock Text="Description:" VerticalAlignment="Center"/>
                                <TextBox Text="{Binding Description}"
                                         IsReadOnly="{Binding IsGeneralFieldReadOnly}"
                                         HorizontalAlignment="Stretch"
                                         MinWidth="{StaticResource TextBoxMinWidth}"
                                         MinHeight="80"
                                         AcceptsReturn="True"
                                         TextWrapping="Wrap"/>
                            </StackPanel>

                            <Grid ColumnDefinitions="*,*" ColumnSpacing="{StaticResource GridGap}">
                                <StackPanel Spacing="{StaticResource SpacingUnit}" Grid.Column="0">
                                    <TextBlock Text="Status:" VerticalAlignment="Center"/>
                                    <ComboBox ItemsSource="{Binding StatusTextOptions}"
                                              SelectedItem="{Binding SelectedStatusText}"
                                              IsEnabled="{Binding CanEditStatus}"
                                              HorizontalAlignment="Stretch"
                                              MinWidth="{StaticResource ComboBoxMinWidth}"/>
                                </StackPanel>
                                <StackPanel Spacing="{StaticResource SpacingUnit}" Grid.Column="1">
                                    <TextBlock Text="Currency:" VerticalAlignment="Center"/>
                                    <TextBox Text="{Binding Currency}"
                                             IsReadOnly="{Binding IsCurrencyReadOnly}"
                                             HorizontalAlignment="Stretch"
                                             MinWidth="{StaticResource TextBoxMinWidth}"/>
                                </StackPanel>
                            </Grid>

                            <StackPanel Spacing="{StaticResource SpacingUnit}">
                                <TextBlock Text="Source:" VerticalAlignment="Center"/>
                                <ComboBox ItemsSource="{Binding SourceOptions}"
                                          SelectedItem="{Binding SelectedSource}"
                                          DisplayMemberBinding="{Binding DisplayName}"
                                          IsEnabled="{Binding AllowEditing}"
                                          HorizontalAlignment="Stretch"
                                          MinWidth="{StaticResource ComboBoxMinWidth}"/>
                            </StackPanel>
                        </StackPanel>
                    </TabItem>

                    <TabItem Header="Financial Data">
                        <StackPanel Spacing="{StaticResource SectionSpacing}">
                            <Grid ColumnDefinitions="*,*" ColumnSpacing="{StaticResource GridGap}">
                                <StackPanel Spacing="{StaticResource SpacingUnit}" Grid.Column="0">
                                    <TextBlock Text="Opening Value:" VerticalAlignment="Center"/>
                                    <TextBox Text="{Binding OpeningValue}"
                                             IsReadOnly="{Binding IsFinancialSnapshotReadOnly}"
                                             HorizontalAlignment="Stretch"
                                             MinWidth="{StaticResource TextBoxMinWidth}"
                                             behaviors:NumericInputNullSafety.IsEnabled="True"/>
                                </StackPanel>
                                <StackPanel Spacing="{StaticResource SpacingUnit}" Grid.Column="1">
                                    <TextBlock Text="Value ETC-P:" VerticalAlignment="Center"/>
                                    <TextBox Text="{Binding ValueEtcp}"
                                             IsReadOnly="{Binding IsGeneralFieldReadOnly}"
                                             HorizontalAlignment="Stretch"
                                             MinWidth="{StaticResource TextBoxMinWidth}"
                                             behaviors:NumericInputNullSafety.IsEnabled="True"/>
                                </StackPanel>
                            </Grid>

                            <Grid ColumnDefinitions="*,*" ColumnSpacing="{StaticResource GridGap}">
                                <StackPanel Spacing="{StaticResource SpacingUnit}" Grid.Column="0">
                                    <TextBlock Text="Opening Expenses:" VerticalAlignment="Center"/>
                                    <TextBox Text="{Binding OpeningExpenses}"
                                             IsReadOnly="{Binding IsFinancialSnapshotReadOnly}"
                                             HorizontalAlignment="Stretch"
                                             MinWidth="{StaticResource TextBoxMinWidth}"
                                             behaviors:NumericInputNullSafety.IsEnabled="True"/>
                                </StackPanel>
                                <StackPanel Spacing="{StaticResource SpacingUnit}" Grid.Column="1">
                                    <TextBlock Text="Expenses ETC-P:" VerticalAlignment="Center"/>
                                    <TextBox Text="{Binding ExpensesEtcp}"
                                             IsReadOnly="{Binding IsGeneralFieldReadOnly}"
                                             HorizontalAlignment="Stretch"
                                             MinWidth="{StaticResource TextBoxMinWidth}"
                                             behaviors:NumericInputNullSafety.IsEnabled="True"/>
                                </StackPanel>
                            </Grid>

                            <Grid ColumnDefinitions="*,*" ColumnSpacing="{StaticResource GridGap}">
                                <StackPanel Spacing="{StaticResource SpacingUnit}" Grid.Column="0">
                                    <TextBlock Text="Planned Hours:" VerticalAlignment="Center"/>
                                    <TextBox Text="{Binding InitialHoursBudget}"
                                             IsReadOnly="{Binding IsFinancialSnapshotReadOnly}"
                                             HorizontalAlignment="Stretch"
                                             MinWidth="{StaticResource TextBoxMinWidth}"
                                             behaviors:NumericInputNullSafety.IsEnabled="True"/>
                                </StackPanel>
                                <StackPanel Spacing="{StaticResource SpacingUnit}" Grid.Column="1">
                                    <TextBlock Text="Estimated Hours:" VerticalAlignment="Center"/>
                                    <TextBox Text="{Binding EstimatedToCompleteHours}"
                                             IsReadOnly="{Binding IsGeneralFieldReadOnly}"
                                             HorizontalAlignment="Stretch"
                                             MinWidth="{StaticResource TextBoxMinWidth}"
                                             behaviors:NumericInputNullSafety.IsEnabled="True"/>
                                </StackPanel>
                            </Grid>

                            <Grid ColumnDefinitions="*,*" ColumnSpacing="{StaticResource GridGap}">
                                <StackPanel Spacing="{StaticResource SpacingUnit}" Grid.Column="0">
                                    <TextBlock Text="Margin % Budget:" VerticalAlignment="Center"/>
                                    <TextBox Text="{Binding MarginPctBudget}"
                                             IsReadOnly="{Binding IsFinancialSnapshotReadOnly}"
                                             HorizontalAlignment="Stretch"
                                             MinWidth="{StaticResource TextBoxMinWidth}"
                                             behaviors:NumericInputNullSafety.IsEnabled="True"/>
                                </StackPanel>
                                <StackPanel Spacing="{StaticResource SpacingUnit}" Grid.Column="1">
                                    <TextBlock Text="Margin % ETC-P:" VerticalAlignment="Center"/>
                                    <TextBox Text="{Binding MarginPctEtcp}"
                                             IsReadOnly="{Binding IsGeneralFieldReadOnly}"
                                             HorizontalAlignment="Stretch"
                                             MinWidth="{StaticResource TextBoxMinWidth}"
                                             behaviors:NumericInputNullSafety.IsEnabled="True"/>
                                </StackPanel>
                            </Grid>

                            <Grid ColumnDefinitions="*,*" ColumnSpacing="{StaticResource GridGap}">
                                <StackPanel Spacing="{StaticResource SpacingUnit}" Grid.Column="0">
                                    <TextBlock Text="ETC-P Age (Days):" VerticalAlignment="Center"/>
                                    <TextBox Text="{Binding EtcpAgeDays, Mode=OneWay}"
                                             IsReadOnly="True"
                                             IsHitTestVisible="False"
                                             IsTabStop="False"
                                             HorizontalAlignment="Stretch"
                                             MinWidth="{StaticResource TextBoxMinWidth}"/>
                                </StackPanel>
                                <StackPanel Spacing="{StaticResource SpacingUnit}" Grid.Column="1">
                                    <TextBlock Text="Last Closing Period:" VerticalAlignment="Center"/>
                                    <TextBox Text="{Binding LastClosingPeriodDisplay}"
                                             IsReadOnly="True"
                                             IsHitTestVisible="False"
                                             IsTabStop="False"
                                             HorizontalAlignment="Stretch"
                                             MinWidth="{StaticResource TextBoxMinWidth}"/>
                                </StackPanel>
                            </Grid>

                            <Grid ColumnDefinitions="*,*" ColumnSpacing="{StaticResource GridGap}">
                                <StackPanel Spacing="{StaticResource SpacingUnit}" Grid.Column="0">
                                    <TextBlock Text="Last ETC Date:" VerticalAlignment="Center"/>
                                    <CalendarDatePicker SelectedDate="{Binding LastEtcDate, Converter={StaticResource DateTimeOffsetToDateTimeConverter}}"
                                                        IsEnabled="False"
                                                        HorizontalAlignment="Stretch"/>
                                </StackPanel>
                                <StackPanel Spacing="{StaticResource SpacingUnit}" Grid.Column="1">
                                    <TextBlock Text="Proposed Next ETC Date:" VerticalAlignment="Center"/>
                                    <CalendarDatePicker SelectedDate="{Binding ProposedNextEtcDate, Converter={StaticResource DateTimeOffsetToDateTimeConverter}}"
                                                        IsEnabled="False"
                                                        HorizontalAlignment="Stretch"/>
                                </StackPanel>
                            </Grid>
                        </StackPanel>
                    </TabItem>

                    <TabItem Header="Financial Evolution">
                        <StackPanel Spacing="{StaticResource SectionSpacing}">
                            <TextBlock Text="Financial Evolution Data" Classes="TitleXSmall"/>
                            <DataGrid ItemsSource="{Binding FinancialEvolutionEntries}"
                                      SelectedItem="{Binding SelectedFinancialEvolutionEntry}"
                                      AutoGenerateColumns="False"
                                      Height="200"
                                      IsReadOnly="{Binding IsFinancialEvolutionReadOnly}">
                                <DataGrid.Columns>
                                    <DataGridTemplateColumn Header="Closing Period" Width="2*">
                                        <DataGridTemplateColumn.CellTemplate>
                                            <DataTemplate x:DataType="vm:EngagementFinancialEvolutionEntryViewModel">
                                                <ComboBox ItemsSource="{Binding DataContext.ClosingPeriods, ElementName=EngagementEditorRoot}"
                                                          SelectedItem="{Binding SelectedClosingPeriod}"
                                                                DisplayMemberBinding="{Binding Name}"/>
                                            </DataTemplate>
                                        </DataGridTemplateColumn.CellTemplate>
                                    </DataGridTemplateColumn>
                                    <DataGridTextColumn Header="Closing Period ID" Binding="{Binding ClosingPeriodId, UpdateSourceTrigger=PropertyChanged}" Width="2*"/>
                                    <DataGridTextColumn Header="Hours" Binding="{Binding Hours, UpdateSourceTrigger=PropertyChanged}" Width="*"/>
                                    <DataGridTextColumn Header="Value" Binding="{Binding Value, UpdateSourceTrigger=PropertyChanged}" Width="*"/>
                                    <DataGridTextColumn Header="Margin" Binding="{Binding Margin, UpdateSourceTrigger=PropertyChanged}" Width="*"/>
                                    <DataGridTextColumn Header="Expenses" Binding="{Binding Expenses, UpdateSourceTrigger=PropertyChanged}" Width="*"/>
                                </DataGrid.Columns>
                            </DataGrid>
                            <StackPanel Orientation="Horizontal"
                                        Spacing="{StaticResource ControlSpacing}"
                                        IsEnabled="{Binding AllowEditing}">
                                <Button Content="Add Period Data"
                                        Command="{Binding AddFinancialEvolutionEntryCommand}"
                                        Classes="accent"/>
                                <Button Content="Remove Selected"
                                        Command="{Binding RemoveFinancialEvolutionEntryCommand}"/>
                            </StackPanel>
                        </StackPanel>
                    </TabItem>

                    <TabItem Header="Assignments">
                        <StackPanel Spacing="{StaticResource SectionSpacing}">
                            <StackPanel Spacing="{StaticResource SectionSpacing}">
                                <TextBlock Text="PAPD Assignments" Classes="TitleXSmall"/>
                                <DataGrid ItemsSource="{Binding PapdAssignments}"
                                          AutoGenerateColumns="False"
                                          IsReadOnly="True"
                                          SelectionMode="Single"
                                          Height="150">
                                    <DataGrid.Columns>
                                        <DataGridTextColumn Header="PAPD" Binding="{Binding Papd.Name}" Width="2*"/>
                                        <DataGridTextColumn Header="Level" Binding="{Binding Papd.Level}" Width="*"/>
                                    </DataGrid.Columns>
                                </DataGrid>
                            </StackPanel>

                            <StackPanel Spacing="{StaticResource SectionSpacing}">
                                <TextBlock Text="Manager Assignments" Classes="TitleXSmall"/>
                                <DataGrid ItemsSource="{Binding ManagerAssignments}"
                                          AutoGenerateColumns="False"
                                          IsReadOnly="True"
                                          Height="150">
                                    <DataGrid.Columns>
                                        <DataGridTextColumn Header="Manager" Binding="{Binding Manager.Name}" Width="2*"/>
                                        <DataGridTextColumn Header="Position" Binding="{Binding Manager.Position}" Width="*"/>
                                    </DataGrid.Columns>
                                </DataGrid>
                            </StackPanel>
                        </StackPanel>
                    </TabItem>

                    <TabItem Header="Additional Sales">
                        <StackPanel Spacing="{StaticResource SectionSpacing}">
                            <TextBlock Text="Additional Sales" Classes="TitleXSmall"/>
                            <DataGrid ItemsSource="{Binding AdditionalSales}"
                                      SelectedItem="{Binding SelectedAdditionalSale}"
                                      AutoGenerateColumns="False"
                                      IsReadOnly="True"
                                      Height="200">
                                <DataGrid.Columns>
                                    <DataGridTextColumn Header="Description" Binding="{Binding Description}" Width="3*"/>
                                    <DataGridTextColumn Header="Opportunity ID" Binding="{Binding OpportunityId}" Width="*"/>
                                    <DataGridTextColumn Header="Value" Binding="{Binding Value, StringFormat='{}{0:N2}'}" Width="*"/>
                                </DataGrid.Columns>
                            </DataGrid>
                            <StackPanel Orientation="Horizontal"
                                        Spacing="{StaticResource ControlSpacing}"
                                        IsEnabled="{Binding AllowEditing}">
                                <SplitButton Content="Additional Sales"
                                             Command="{Binding AddAdditionalSaleCommand}"
                                             MinWidth="{StaticResource ButtonMinWidth}">
                                    <SplitButton.Flyout>
                                        <MenuFlyout>
                                            <MenuItem Header="Add Additional Sale"
                                                      Command="{Binding AddAdditionalSaleCommand}"/>
                                            <MenuItem Header="View Additional Sales"
                                                      Command="{Binding ViewAdditionalSalesCommand}"/>
                                        </MenuFlyout>
                                    </SplitButton.Flyout>
                                </SplitButton>
                                <Button Content="Delete Selected"
                                        Command="{Binding DeleteAdditionalSaleCommand}"
                                        IsEnabled="{Binding CanDeleteAdditionalSale}"/>
                            </StackPanel>
                        </StackPanel>
                    </TabItem>
                </TabControl>
            </StackPanel>
        </ScrollViewer>

        <StackPanel Grid.Row="1"
                    Orientation="Horizontal"
                    HorizontalAlignment="Right"
                    Spacing="{StaticResource ControlSpacing}">
            <Button Content="{loc:Loc Key=Global_Button_Save}"
                    Command="{Binding SaveCommand}"
                    IsEnabled="{Binding CanSave}"
                    IsDefault="{Binding CanSave}"
                    MinWidth="{StaticResource ButtonMinWidth}" />
            <Button Content="{loc:Loc Key=Global_Button_Cancel}"
                    Command="{Binding CloseCommand}"
                    IsCancel="True"
                    MinWidth="{StaticResource ButtonMinWidth}" />
        </StackPanel>
    </Grid>
</UserControl>